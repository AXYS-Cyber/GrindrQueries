/*Grindr for iOS v25.2 as of 4/16/25
updates to ztext and profile name joins*/


SELECT
        ZCHATMESSAGEENTITY.ZSENDERID AS SenderID,
    sender_profile.ZNAME AS SenderName,
    -- RecipientID: Extract the other ID from ZCONVERSATIONID
    CASE
        WHEN ZCHATMESSAGEENTITY.ZSENDERID IS NULL THEN NULL
        WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ZCHATMESSAGEENTITY.ZSENDERID || ':') = 1
            THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') + 1)
        WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':' || ZCHATMESSAGEENTITY.ZSENDERID) > 0
            THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, 1, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') - 1)
        ELSE NULL
    END AS RecipientID,
    recip_profile.ZNAME AS RecipientName,
    -- Reaction: Aggregate ZPROFILEID; type: ZREACTIONTYPE
    GROUP_CONCAT(
        CASE 
            WHEN ZCHATREACTIONENTITY.ZPROFILEID IS NOT NULL 
            THEN ZCHATREACTIONENTITY.ZPROFILEID || '; type: ' || ZCHATREACTIONENTITY.ZREACTIONTYPE
            ELSE NULL 
        END
    ) AS Reaction,
    datetime('2001-01-01', ZCHATMESSAGEENTITY.ZTIMESTAMP || ' seconds') AS Time,
    ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE AS ChatType,
    ZCHATMESSAGECONTENTENTITY.ZTEXT2 AS ChatText,
    -- Multi-media Content
    CASE 
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'text' THEN 
            COALESCE(
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZRESULT IS NOT NULL THEN 'Result: ' || ZCHATMESSAGECONTENTENTITY.ZRESULT || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL IS NOT NULL THEN 'URL: ' || ZCHATMESSAGECONTENTENTITY.ZURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL1 IS NOT NULL THEN 'URL1: ' || ZCHATMESSAGECONTENTENTITY.ZURL1 || '; ' ELSE '' END,
                'No further details available'
            )
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'location' THEN 
            ZCHATMESSAGECONTENTENTITY.ZLATITUDE || ', ' || ZCHATMESSAGECONTENTENTITY.ZLONGITUDE
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'videoCall' THEN 
            ZCHATMESSAGECONTENTENTITY.ZRESULT || ', ' || ZCHATMESSAGECONTENTENTITY.ZVIDEOCALLDURATION || ' seconds'
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE IN ('image', 'video', 'expiringImage', 'giphy') THEN --Lists the table column and content information.
            COALESCE(
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZRESULT IS NOT NULL THEN 'Result: ' || ZCHATMESSAGECONTENTENTITY.ZRESULT || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL IS NOT NULL THEN 'URL: ' || ZCHATMESSAGECONTENTENTITY.ZURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL1 IS NOT NULL THEN 'URL1: ' || ZCHATMESSAGECONTENTENTITY.ZURL1 || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZPREVIEWURL IS NOT NULL THEN 'Preview URL: ' || ZCHATMESSAGECONTENTENTITY.ZPREVIEWURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZSTILLURL IS NOT NULL THEN 'Still URL: ' || ZCHATMESSAGECONTENTENTITY.ZSTILLURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL2 IS NOT NULL THEN 'URL2: ' || ZCHATMESSAGECONTENTENTITY.ZURL2 || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL3 IS NOT NULL THEN 'URL3: ' || ZCHATMESSAGECONTENTENTITY.ZURL3 || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL4 IS NOT NULL THEN 'URL4: ' || ZCHATMESSAGECONTENTENTITY.ZURL4 || '; ' ELSE '' END ||
                'Hash: ' || COALESCE(ZCHATMESSAGECONTENTENTITY.ZIMAGEHASH, 'None') || '; ' ||
                'Dimensions: ' || COALESCE(ZMEDIAHASHENTITY.ZWIDTH, ZCHATMESSAGECONTENTENTITY.ZWIDTH, 'Unknown') || 'x' || 
                COALESCE(ZMEDIAHASHENTITY.ZHEIGHT, ZCHATMESSAGECONTENTENTITY.ZHEIGHT, 'Unknown') || '; ' ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'video' AND ZCHATMESSAGECONTENTENTITY.ZDURATION IS NOT NULL 
                     THEN 'Duration: ' || ZCHATMESSAGECONTENTENTITY.ZDURATION || 's; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'expiringImage' AND ZCHATMESSAGECONTENTENTITY.ZVIEWSREMAINING IS NOT NULL 
                     THEN 'Views Remaining: ' || ZCHATMESSAGECONTENTENTITY.ZVIEWSREMAINING || '; ' ELSE '' END ||
                CASE WHEN ZMEDIAHASHENTITY.ZNUMBEROFPLAYS IS NOT NULL THEN 'Plays: ' || ZMEDIAHASHENTITY.ZNUMBEROFPLAYS || '; ' ELSE '' END,
                'No further details available'
            )
        ELSE 'Unknown Content Type'
    END AS MultiMediaContent,
    ZCHATMESSAGEENTITY.ZMESSAGEID AS MessageID,
    ZCHATMESSAGEENTITY.ZCONVERSATIONID AS ConversationID
FROM
    ZCHATMESSAGECONTENTENTITY
LEFT JOIN
    ZCHATMESSAGEENTITY ON ZCHATMESSAGECONTENTENTITY.ZMESSAGE = ZCHATMESSAGEENTITY.Z_PK
-- Sender name join
LEFT JOIN
    ZPROFILEENTITY AS sender_profile
    ON ZCHATMESSAGEENTITY.ZSENDERID = sender_profile.ZPROFILEID
-- Recipient name join
LEFT JOIN
    ZPROFILEENTITY AS recip_profile
    ON (
        CASE
            WHEN ZCHATMESSAGEENTITY.ZSENDERID IS NULL THEN NULL
            WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ZCHATMESSAGEENTITY.ZSENDERID || ':') = 1
                THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') + 1)
            WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':' || ZCHATMESSAGEENTITY.ZSENDERID) > 0
                THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, 1, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') - 1)
            ELSE NULL
        END
    ) = recip_profile.ZPROFILEID
-- Reaction join
LEFT JOIN
    ZCHATREACTIONENTITY ON ZCHATMESSAGEENTITY.ZMESSAGEID = ZCHATREACTIONENTITY.ZMESSAGEID
LEFT JOIN
    ZMEDIAHASHENTITY ON ZCHATMESSAGECONTENTENTITY.ZIMAGEHASH = ZMEDIAHASHENTITY.ZMEDIAHASH
GROUP BY
    ZCHATMESSAGECONTENTENTITY.Z_PK,
    ZCHATMESSAGEENTITY.Z_PK
ORDER BY
    ZCHATMESSAGEENTITY.ZTIMESTAMP;
