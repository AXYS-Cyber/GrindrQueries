--Validated on Grindr for iOS 24.8
--For device user's ID, their profile name is not a field within database and will be listed as null
--Obtaining profiles from zinboxconversationentity.zname


SELECT
    ZCHATMESSAGEENTITY.ZSENDERID AS SenderID,
    sender_conv.ZNAME AS SenderName,
    -- RecipientID: Extract the other ID from ZCONVERSATIONID
    CASE
        WHEN ZCHATMESSAGEENTITY.ZSENDERID IS NULL THEN NULL
        WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ZCHATMESSAGEENTITY.ZSENDERID || ':') = 1
            THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') + 1)
        WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':' || ZCHATMESSAGEENTITY.ZSENDERID) > 0
            THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, 1, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') - 1)
        ELSE NULL
    END AS RecipientID,
    recip_conv.ZNAME AS RecipientName,
    -- Reaction: Aggregate [ZPROFILEID]; type: [ZREACTIONTYPE]
    GROUP_CONCAT(
        CASE 
            WHEN ZCHATREACTIONENTITY.ZPROFILEID IS NOT NULL 
            THEN ZCHATREACTIONENTITY.ZPROFILEID || '; type: ' || ZCHATREACTIONENTITY.ZREACTIONTYPE
            ELSE NULL 
        END
    ) AS Reaction,
    datetime('2001-01-01', ZCHATMESSAGEENTITY.ZTIMESTAMP || ' seconds') AS Time,
    ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE AS ChatType,
    ZCHATMESSAGECONTENTENTITY.ZTEXT AS ChatText,
    -- Contains multiple fields from ZCHATMESSAGECONTENTENTITY, labeled by column; data
    CASE 
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'text' THEN 
            COALESCE(
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZRESULT IS NOT NULL THEN 'Result: ' || ZCHATMESSAGECONTENTENTITY.ZRESULT || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL IS NOT NULL THEN 'URL: ' || ZCHATMESSAGECONTENTENTITY.ZURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL1 IS NOT NULL THEN 'URL1: ' || ZCHATMESSAGECONTENTENTITY.ZURL1 || '; ' ELSE '' END,
                'No further details available'
            )
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'location' THEN 
            ZCHATMESSAGECONTENTENTITY.ZLATITUDE || ', ' || ZCHATMESSAGECONTENTENTITY.ZLONGITUDE
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'videoCall' THEN 
            ZCHATMESSAGECONTENTENTITY.ZRESULT || ', ' || ZCHATMESSAGECONTENTENTITY.ZVIDEOCALLDURATION || ' seconds'
        WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE IN ('image', 'video', 'expiringImage', 'giphy') THEN 
            COALESCE(
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZRESULT IS NOT NULL THEN 'Result: ' || ZCHATMESSAGECONTENTENTITY.ZRESULT || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL IS NOT NULL THEN 'URL: ' || ZCHATMESSAGECONTENTENTITY.ZURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL1 IS NOT NULL THEN 'URL1: ' || ZCHATMESSAGECONTENTENTITY.ZURL1 || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZPREVIEWURL IS NOT NULL THEN 'Preview URL: ' || ZCHATMESSAGECONTENTENTITY.ZPREVIEWURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZSTILLURL IS NOT NULL THEN 'Still URL: ' || ZCHATMESSAGECONTENTENTITY.ZSTILLURL || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL2 IS NOT NULL THEN 'URL2: ' || ZCHATMESSAGECONTENTENTITY.ZURL2 || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL3 IS NOT NULL THEN 'URL3: ' || ZCHATMESSAGECONTENTENTITY.ZURL3 || '; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZURL4 IS NOT NULL THEN 'URL4: ' || ZCHATMESSAGECONTENTENTITY.ZURL4 || '; ' ELSE '' END ||
                'Hash: ' || COALESCE(ZCHATMESSAGECONTENTENTITY.ZIMAGEHASH, 'None') || '; ' ||
                'Dimensions: ' || COALESCE(ZMEDIAHASHENTITY.ZWIDTH, ZCHATMESSAGECONTENTENTITY.ZWIDTH, 'Unknown') || 'x' || 
                COALESCE(ZMEDIAHASHENTITY.ZHEIGHT, ZCHATMESSAGECONTENTENTITY.ZHEIGHT, 'Unknown') || '; ' ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'video' AND ZCHATMESSAGECONTENTENTITY.ZDURATION IS NOT NULL 
                     THEN 'Duration: ' || ZCHATMESSAGECONTENTENTITY.ZDURATION || 's; ' ELSE '' END ||
                CASE WHEN ZCHATMESSAGECONTENTENTITY.ZCONTENTTYPE = 'expiringImage' AND ZCHATMESSAGECONTENTENTITY.ZVIEWSREMAINING IS NOT NULL 
                     THEN 'Views Remaining: ' || ZCHATMESSAGECONTENTENTITY.ZVIEWSREMAINING || '; ' ELSE '' END ||
                CASE WHEN ZMEDIAHASHENTITY.ZNUMBEROFPLAYS IS NOT NULL THEN 'Plays: ' || ZMEDIAHASHENTITY.ZNUMBEROFPLAYS || '; ' ELSE '' END,
                'No further details available'
            )
        ELSE 'Unknown Content Type'
    END AS MultiMediaContent,
    -- Reaction: Aggregate [ZPROFILEID]; type: [ZREACTIONTYPE]
    GROUP_CONCAT(
        CASE 
            WHEN ZCHATREACTIONENTITY.ZPROFILEID IS NOT NULL 
            THEN ZCHATREACTIONENTITY.ZPROFILEID || '; type: ' || ZCHATREACTIONENTITY.ZREACTIONTYPE
            ELSE NULL 
        END
    ) AS Reaction,
	ZCHATMESSAGEENTITY.ZMESSAGEID AS MessageID,
    ZCHATMESSAGEENTITY.ZCONVERSATIONID AS ConversationID
FROM
    ZCHATMESSAGECONTENTENTITY
LEFT JOIN
    ZCHATMESSAGEENTITY ON ZCHATMESSAGECONTENTENTITY.ZMESSAGE = ZCHATMESSAGEENTITY.Z_PK
-- Sender join
LEFT JOIN
    ZINBOXCONVERSATIONPARTICIPANTENTITY AS sender_participant
    ON ZCHATMESSAGEENTITY.ZSENDERID = sender_participant.ZPROFILEID
LEFT JOIN
    ZINBOXCONVERSATIONENTITY AS sender_conv
    ON sender_participant.ZINBOXCONVERSATION = sender_conv.Z_PK
    AND (sender_conv.ZCONVERSATIONID LIKE ZCHATMESSAGEENTITY.ZSENDERID || ':%'
         OR sender_conv.ZCONVERSATIONID LIKE '%:' || ZCHATMESSAGEENTITY.ZSENDERID)
-- Recipient join
LEFT JOIN
    ZINBOXCONVERSATIONPARTICIPANTENTITY AS recip_participant
    ON (
        CASE
            WHEN ZCHATMESSAGEENTITY.ZSENDERID IS NULL THEN NULL
            WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ZCHATMESSAGEENTITY.ZSENDERID || ':') = 1
                THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') + 1)
            WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':' || ZCHATMESSAGEENTITY.ZSENDERID) > 0
                THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, 1, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') - 1)
            ELSE NULL
        END
    ) = recip_participant.ZPROFILEID
LEFT JOIN
    ZINBOXCONVERSATIONENTITY AS recip_conv
    ON recip_participant.ZINBOXCONVERSATION = recip_conv.Z_PK
    AND (
        recip_conv.ZCONVERSATIONID LIKE (
            CASE
                WHEN ZCHATMESSAGEENTITY.ZSENDERID IS NULL THEN NULL
                WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ZCHATMESSAGEENTITY.ZSENDERID || ':') = 1
                    THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') + 1)
                WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':' || ZCHATMESSAGEENTITY.ZSENDERID) > 0
                    THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, 1, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') - 1)
                ELSE NULL
            END
        ) || ':%'
        OR recip_conv.ZCONVERSATIONID LIKE '%' || (
            CASE
                WHEN ZCHATMESSAGEENTITY.ZSENDERID IS NULL THEN NULL
                WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ZCHATMESSAGEENTITY.ZSENDERID || ':') = 1
                    THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') + 1)
                WHEN INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':' || ZCHATMESSAGEENTITY.ZSENDERID) > 0
                    THEN SUBSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, 1, INSTR(ZCHATMESSAGEENTITY.ZCONVERSATIONID, ':') - 1)
                ELSE NULL
            END
        )
    )
-- Reaction join
LEFT JOIN
    ZCHATREACTIONENTITY ON ZCHATMESSAGEENTITY.ZMESSAGEID = ZCHATREACTIONENTITY.ZMESSAGEID
LEFT JOIN
    ZMEDIAHASHENTITY ON ZCHATMESSAGECONTENTENTITY.ZIMAGEHASH = ZMEDIAHASHENTITY.ZMEDIAHASH
GROUP BY
    ZCHATMESSAGECONTENTENTITY.Z_PK,
    ZCHATMESSAGEENTITY.Z_PK
ORDER BY
    ZCHATMESSAGEENTITY.ZTIMESTAMP;
